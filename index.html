<script>
  // CONFIG
  const LAVA_URL_RU = 'https://app.lava.top/ru/products/9ea4bb05-5fb7-414f-9813-ac5855b2029a/6783c63f-0fd4-4afb-9d99-951df743767b?currency=RUB';
  const LAVA_URL_INT = 'https://example.com/pay?currency=USD'; // <— замени на свою ссылку
  const PRODUCT = 'Доступ в FastGuide';
  const PRICE_RU = '390 RUB';
  const PRICE_INT = '10 USD'; // <— замени на свою сумму

  // STATE
  let method = '';
  let email = '';
  let price = PRICE_RU;
  let payUrl = LAVA_URL_RU;

  // elements
  const mRus = document.getElementById('m_rus');
  const mInt = document.getElementById('m_int');
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const p1 = document.getElementById('stepIndicator1');
  const p2 = document.getElementById('stepIndicator2');
  const p3 = document.getElementById('stepIndicator3');
  const cMethod = document.getElementById('c_method');
  const cEmail = document.getElementById('c_email');
  const openPayment = document.getElementById('openPayment');
  const priceEls = document.querySelectorAll('.price span:first-child');
  const confirmPriceEl = document.querySelector('#step2 .value:last-child');

  // choose method
  function choose(name, el){
    method = name;
    [mRus, mInt].forEach(x => x.classList.remove('active'));
    el.classList.add('active');

    if(name === 'Банк РФ') {
      price = PRICE_RU;
      payUrl = LAVA_URL_RU;
    } else {
      price = PRICE_INT;
      payUrl = LAVA_URL_INT;
    }

    priceEls.forEach(el => el.textContent = price.split(' ')[0]);
    confirmPriceEl.textContent = price;
    document.getElementById('email').focus();
  }

  // validation email
  function isEmail(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  }

  // go to confirm
  function toStep2(){
    const e = document.getElementById('email').value.trim();
    if(!method) { alert('Выберите метод оплаты'); return; }
    if(!isEmail(e)) { alert('Введите корректный email'); document.getElementById('email').focus(); return; }
    email = e;
    cMethod.textContent = method;
    cEmail.textContent = email;
    confirmPriceEl.textContent = price;

    p1.classList.remove('active'); p1.classList.add('done');
    p2.classList.add('active');

    step1.style.display = 'none';
    step2.style.display = 'block';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function backToStep1(e){
    if(e) e.preventDefault();
    step2.style.display = 'none';
    step1.style.display = 'block';
    p2.classList.remove('active'); p1.classList.remove('done'); p1.classList.add('active');
  }

  // proceed to payment
  function proceedToPay(){
    let url = payUrl;
    try {
      const u = new URL(payUrl);
      if(email) u.searchParams.set('buyer_email', email);
      u.searchParams.set('utm_source', 'fastguide_miniapp');
      url = u.toString();
    } catch(e){ url = payUrl; }

    openPayment.href = url;

    const wnd = window.open(url, '_blank');
    if(!wnd){
      alert('Браузер заблокировал открытие. Нажмите "Открыть страницу оплаты".');
    }

    step2.style.display = 'none';
    step3.style.display = 'block';
    p2.classList.remove('active'); p2.classList.add('done');
    p3.classList.add('active');

    startPolling();
  }

  function startPolling(){
    const params = new URLSearchParams(location.search);
    if(params.get('debug') === '1') document.getElementById('devActions').style.display = 'block';
  }

  function onPaid(info){
    alert('Оплата подтверждена — выдан доступ.');
  }

  function simulateSuccess(){
    onPaid({status:'paid'});
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      if(step1.style.display !== 'none') toStep2();
      else if(step2.style.display !== 'none') proceedToPay();
    }
  });

  [mRus, mInt].forEach(el=>{
    el.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); el.click(); }
    });
  });
</script>
